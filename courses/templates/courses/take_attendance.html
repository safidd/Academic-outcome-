{% extends 'users/base.html' %}
{% load dict_filters %}

{% block title %}Take Attendance - {{ course.code }} - Academic Outcome Tracker{% endblock %}

{% block content %}
<div class="cyber-hero mb-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3 align-items-start">
        <div>
            <p class="cyber-eyebrow mb-2">Instructor · Attendance Tracking</p>
            <h2 class="mb-2">Record attendance for {{ course.code }}</h2>
            <p class="metric-subtext mb-0">
                Mark each student's attendance status for the selected date. Changes are saved automatically.
            </p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <span class="cyber-chip">{{ enrolled_students|length }} students</span>
            <span class="cyber-chip">Bulk update enabled</span>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-12">
        <div class="cyber-panel">
            <div class="cyber-panel-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Attendance Entry</h4>
                <span class="cyber-chip">Required fields</span>
            </div>
            <div class="cyber-panel-body">
                <form method="post" id="attendanceForm">
                    {% csrf_token %}
                    
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <label for="{{ form.date.id_for_label }}" class="form-label text-uppercase small" style="color: var(--text-muted);">
                                {{ form.date.label }}
                            </label>
                            <input type="date" 
                                   name="date" 
                                   id="{{ form.date.id_for_label }}" 
                                   class="form-control" 
                                   value="{% if form.date.value %}{{ form.date.value|date:'Y-m-d' }}{% else %}{{ form.date.initial|date:'Y-m-d' }}{% endif %}" 
                                   required>
                            {% if form.date.errors %}
                                <div class="text-danger small mt-1">{{ form.date.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if enrolled_students %}
                        <div class="table-responsive">
                            <table class="neon-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="width: 40%;">Student Name</th>
                                        <th style="width: 20%; text-align: center;">Present</th>
                                        <th style="width: 20%; text-align: center;">Absent</th>
                                        <th style="width: 20%; text-align: center;">Late</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in enrolled_students %}
                                        <tr>
                                            <td>
                                                <strong>{{ student.get_full_name|default:student.username }}</strong>
                                                <div style="color: var(--text-muted); font-size: 0.875rem;">{{ student.username }}</div>
                                            </td>
                                            <td style="text-align: center;">
                                                <input type="radio" 
                                                       name="attendance_{{ student.id }}" 
                                                       id="present_{{ student.id }}" 
                                                       value="Present" 
                                                       class="form-check-input" 
                                                       {% if existing_attendance|get_item:student.id == 'Present' or not existing_attendance|get_item:student.id %}checked{% endif %}
                                                       required>
                                                <label for="present_{{ student.id }}" class="form-check-label ms-2" style="color: #28a745;">✓</label>
                                            </td>
                                            <td style="text-align: center;">
                                                <input type="radio" 
                                                       name="attendance_{{ student.id }}" 
                                                       id="absent_{{ student.id }}" 
                                                       value="Absent" 
                                                       class="form-check-input" 
                                                       {% if existing_attendance|get_item:student.id == 'Absent' %}checked{% endif %}>
                                                <label for="absent_{{ student.id }}" class="form-check-label ms-2" style="color: #dc3545;">✗</label>
                                            </td>
                                            <td style="text-align: center;">
                                                <input type="radio" 
                                                       name="attendance_{{ student.id }}" 
                                                       id="late_{{ student.id }}" 
                                                       value="Late" 
                                                       class="form-check-input" 
                                                       {% if existing_attendance|get_item:student.id == 'Late' %}checked{% endif %}>
                                                <label for="late_{{ student.id }}" class="form-check-label ms-2" style="color: #ffc107;">⏰</label>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-4" style="border-top: 2px solid var(--border);">
                            <a href="{% url 'instructor:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
                            <button type="submit" class="btn btn-primary">Save Attendance</button>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <strong>No enrolled students found.</strong> Students must have grades recorded in this course to appear in the attendance list.
                        </div>
                        <div class="mt-3">
                            <a href="{% url 'instructor:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    @media (max-width: 768px) {
        .neon-table {
            font-size: 0.875rem;
        }
        .neon-table th,
        .neon-table td {
            padding: 0.5rem;
        }
        .form-check-input {
            width: 1.2rem;
            height: 1.2rem;
        }
    }
    
    .form-check-input:checked {
        background-color: var(--accent);
        border-color: var(--accent);
    }
    
    .form-check-label {
        cursor: pointer;
        user-select: none;
    }
</style>
{% endblock %}

